<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8" />
    <title>İsim Şehir Oyunu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        #timer {
            font-size: 2rem;
            font-weight: bold;
        }

        #letter {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="p-4">
    <h2>İsim Şehir Oyunu</h2>

    <div class="mb-4">
        <div id="letter" class="text-primary">?</div>
        <div>Kalan Süre: <span id="timer" class="text-danger">-</span> saniye</div>
    </div>

    <form id="answerForm">
        <div class="mb-3"><label class="form-label">İsim</label><input type="text" class="form-control" name="isim"
                required></div>
        <div class="mb-3"><label class="form-label">Şehir</label><input type="text" class="form-control" name="sehir"
                required></div>
        <div class="mb-3"><label class="form-label">Hayvan</label><input type="text" class="form-control" name="hayvan"
                required></div>
        <div class="mb-3"><label class="form-label">Bitki</label><input type="text" class="form-control" name="bitki"
                required></div>
        <div class="mb-3"><label class="form-label">Ünlü</label><input type="text" class="form-control" name="unlu"
                required></div>
        <div class="mb-3"><label class="form-label">Eşya</label><input type="text" class="form-control" name="esya"
                required></div>

        <button type="button" id="finishBtn" class="btn btn-warning">Bitirdim</button>
    </form>

    <hr />

    <!-- Modal -->
    <div class="modal fade" id="answerReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCategoryTitle">İsim Cevapları</h5>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Oyuncu</th>
                                <th>Cevap</th>
                                <th>İtiraz</th>
                            </tr>
                        </thead>
                        <tbody id="modalAnswerTableBody">
                            <!-- Dinamik cevaplar burada -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button id="nextCategoryBtn" class="btn btn-primary">Sonrakine Geç</button>
                </div>
            </div>
        </div>
    </div>


    <div id="answersSection" class="d-none mt-5">
        <h4>Oyuncu Cevapları</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Oyuncu</th>
                    <th>İsim</th>
                    <th>Şehir</th>
                    <th>Hayvan</th>
                    <th>Bitki</th>
                    <th>Ünlü</th>
                    <th>Eşya</th>
                    <th>İtiraz</th>
                </tr>
            </thead>
            <tbody id="answersTableBody"></tbody>
        </table>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>


    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get("game_id");
        const playerName = urlParams.get("player_name");

        let currentLetter = "?"; // sunucudan gelecek
        const letterDisplay = document.getElementById("letter");
        const timer = document.getElementById("timer");
        const form = document.getElementById("answerForm");

        const ws = new WebSocket(`ws://192.168.1.118:8000/ws/${gameId}/${playerName}`);

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            currentLetter = msg.round_letter || currentLetter;
            letterDisplay.textContent = currentLetter;

            if (msg.type === "start_final_timer") {
                alert("Bir oyuncu bitirdi! 20 saniyeniz kaldı.");

                let remaining = msg.seconds;
                timer.textContent = remaining;

                const interval = setInterval(() => {
                    remaining--;
                    timer.textContent = remaining;

                    if (remaining <= 0) {
                        clearInterval(interval);
                        timer.textContent = "Süre doldu!";
                        form.querySelectorAll("input").forEach(inp => inp.disabled = true);
                        sendAnswers(); // otomatik gönder
                    }
                }, 1000);
            }

            if (msg.type === "show_answers") {
                const categories = ["isim", "sehir", "hayvan", "bitki", "unlu", "esya"];
                let currentCategoryIndex = 0;

                function showNextCategoryModal() {
                    if (currentCategoryIndex >= categories.length) {
                        // Oyun bitti, yeni harf başlat
                        ws.send(JSON.stringify({ type: "next_round" }));
                        return;
                    }

                    const category = categories[currentCategoryIndex];
                    document.getElementById("modalCategoryTitle").textContent = category.toUpperCase() + " Cevapları";

                    const tableBody = document.getElementById("modalAnswerTableBody");
                    tableBody.innerHTML = "";

                    msg.answers.forEach(ans => {
                        const row = document.createElement("tr");

                        const playerCell = document.createElement("td");
                        playerCell.textContent = ans.player;

                        const answerCell = document.createElement("td");
                        answerCell.textContent = ans[category];

                        const itirazCell = document.createElement("td");
                        if (ans.player !== playerName) {
                            const btn = document.createElement("button");
                            btn.className = "btn btn-sm btn-danger";
                            btn.textContent = "İtiraz Et";
                            btn.onclick = () => {
                                if (ws.readyState === WebSocket.OPEN) {
                                    ws.send(JSON.stringify({
                                        type: "challenge_answer",
                                        challenger: playerName,
                                        target: ans.player,
                                        category: category,
                                        answer: ans[category],
                                        round_letter: currentLetter
                                    }));
                                    alert(`${ans.player} adlı oyuncunun "${category}" cevabına itiraz ettiniz.`);
                                }
                            };
                            itirazCell.appendChild(btn);
                        } else {
                            itirazCell.textContent = "-";
                        }

                        row.appendChild(playerCell);
                        row.appendChild(answerCell);
                        row.appendChild(itirazCell);
                        tableBody.appendChild(row);
                    });

                    const modal = new bootstrap.Modal(document.getElementById("answerReviewModal"));
                    modal.show();

                    document.getElementById("nextCategoryBtn").onclick = () => {
                        modal.hide();
                        currentCategoryIndex++;
                        setTimeout(showNextCategoryModal, 500); // bir sonraki modalı aç
                    };
                }

                showNextCategoryModal();
            }
        };

        document.getElementById("finishBtn").addEventListener("click", () => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("round_finished");
                sendAnswers(); // bitiren hemen gönderiyor
                form.querySelectorAll("input").forEach(inp => inp.disabled = true);
            }
        });

        function sendAnswers() {
            const formData = new FormData(form);
            console.log('Form Data:', formData);

            const cevaplar = Object.fromEntries(formData.entries());
            console.log('***', cevaplar);


            const payload = {
                game_id: gameId,
                player_name: playerName,
                round_letter: currentLetter,
                isim: cevaplar.isim || "",
                sehir: cevaplar.sehir || "",
                hayvan: cevaplar.hayvan || "",
                bitki: cevaplar.bitki || "",
                unlu: cevaplar.unlu || "",
                esya: cevaplar.esya || ""
            };

            fetch(`http://192.168.1.118:8000/submit-answer`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(res => {
                if (!res.ok) throw new Error("Cevaplar gönderilemedi.");
            }).catch(err => console.error(err));
        }
    </script>
</body>

</html>